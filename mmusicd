#!/bin/bash 
    
list=~/.listmusic
upcoming=~/.upcomingmusic

mplayerfifo=/tmp/mplayerfifo
stoploop=/tmp/stoploop

playing=/tmp/playing
prev=/tmp/prev

if [ ! -f "$list" ]
then
    touch "$list"
fi

if [ ! -f "$upcoming" ]
then
    touch "$upcoming"
fi

function startplaying {
    if [ -a "$mplayerfifo" ]
    then
        rm "$mplayerfifo"
    fi

    if [ -a "$playing" ]
    then
        rm "$playing"
    fi

    mkfifo "$mplayerfifo"
    touch "$playing"

    for (( ; ; ))
    do
        song=`cat "$playing"`
        if [ -z "$song" ]
        then
            song=`$0 getrandom`
            echo "$song" > "$playing"
        fi
        if [ -z "$song" ]
        then
            echo "You have no songs in upcoming or list. I will slowly walk away is sorrow now..."
            exit
        fi

        mplayer -really-quiet -slave -input file="$mplayerfifo" "$song"
        echo "$song" > "$prev"

        next=`cat "$upcoming" | head -1`
        echo "$next" > "$playing"

        tail -n +2 "$upcoming" > /tmp/tmpupcoming
        cat /tmp/tmpupcoming > "$upcoming"
        rm /tmp/tmpupcoming

        if [ -a "$stoploop" ]
        then
            break
        fi

        sleep 0.5
    done

    rm "$playing"
    rm "$mplayerfifo"
}

function getrandom {
    RAND=`od -d -N2 -An /dev/urandom`
    LINES=`cat "$list" | wc -l`
    if [ "0" -eq "$LINES" ]
    then
        echo ""
        exit
    fi
    N=$(( RAND % LINES + 1 ))
    LINE=`head -$N $list | tail -1`
    echo "$LINE"
}

function skip {
    next=`cat "$upcoming" | head -1`
    echo "$next" > "$playing"
    echo "q" > "$mplayerfifo"
}

function exitd {
    touch "$stoploop"
    echo "quit" > "$mplayerfifo"

    if [ -n "$2" ]
    then
        sleep $(($2 - 0.5))
    fi

    sleep 0.5

    if [ -a "$mplayerfifo" ] 
    then 
        rm "$mplayerfifo"
    fi

    rm "$stoploop"
}

function add {
    file="$upcoming"
    if [ "$1" == "list" ]
    then
        file="$list"
    fi

    if [ "$2" == "random" ]
    then
        song=getrandom
        echo "$song" >> "$file"
    fi

    if [ "$2" == "folder" ]
    then
        folder="$3"

        find "$folder" -name "*.*" >> "$file"
    fi

    if [ "$2" == "file" ]
    then
        echo "$3" >> "$file"
    fi

    if [ "$file" == "$list" ]
    then
        sort -f "$file" > "/tmp/sorting"
        cat "/tmp/sorting" > "$file"
        rm "/tmp/sorting"
    fi
}

if [ "$1" == "play" ]
then
    echo "quit" > "$mplayerfifo"
    sleep 0.25 
    echo "$2" > "$playing"
fi

if [ -z "$1" ]
then
    startplaying &
fi

if [ "$1" == "getrandom" ]
then
    getrandom
fi

if [ "$1" == "clear" ]
then
    rm "$upcoming"
    touch "$upcoming"
fi

if [ "$1" == "skip" ]
then
    skip
fi

if [ "$1" == "stop" ]
then
    exitd 
fi

if [ "$1" == "add" ]
then 
    add "$2" "$3" "$4"
fi

if [ "$1" == "playing" ]
then
    if [ -a "$playing" ]
    then
        cat "$playing"
    fi
fi

if [ "$1" == "upcoming" ]
then
    echo "$upcoming"
fi

if [ "$1" == "list" ]
then
    echo "$list"
fi

if [ "$1" == "pause" ]
then
    echo "pause" > "$mplayerfifo"
fi
